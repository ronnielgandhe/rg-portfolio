---
export const prerender = false;
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import BlogPostLayoutEnhanced from '../../layouts/BlogPostLayoutEnhanced.astro';
import { getRecentBlogPosts } from '../../utils/blog';
import { getFixedBackgroundKey, getOptimizedBackgrounds } from '../../utils/backgrounds';

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch all blog posts and find the one with matching slug or id
const allPosts = await getCollection('blog', ({ id }) => {
  return !id.startsWith('_archive/');
});
const post = allPosts.find(p => {
  const postSlug = p.data.slug || p.slug;
  return postSlug === slug || p.id === slug;
});

if (!post) {
  return Astro.redirect('/404');
}

// Get optimized backgrounds
const backgroundMap = await getOptimizedBackgrounds(getImage);

// Fetch recent blog posts for navigation
const recentPosts = await getRecentBlogPosts();
---

<Layout
  title={`${post.data.title} - Ronniel Gandhe`}
  description={post.data.summary}
  canonical={`https://ronnielgandhe.com/blog/${post.data.slug}`}
>
  <BlogPostLayoutEnhanced
    post={post}
    backgroundMap={backgroundMap}
    recentPosts={recentPosts}
  />
</Layout>