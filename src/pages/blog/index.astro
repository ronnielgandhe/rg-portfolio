---
export const prerender = false;
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import BlogLayout from '../../layouts/BlogLayout';
import { getRecentBlogPosts } from '../../utils/blog';
import { getFixedBackgroundKey, getOptimizedBackgrounds } from '../../utils/backgrounds';

const posts = await getCollection('blog', ({ id }) => {
  return !id.startsWith('_archive/');
});
const sortedPosts = posts.sort((a, b) => 
  new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);

// Format posts for the BlogLayout component
const formattedPosts = sortedPosts.map((post) => ({
  title: post.data.title,
  slug: post.data.slug,
  summary: post.data.summary,
  publishedAt: post.data.publishedAt,
  readingTime: post.data.readingTime,
  tags: post.data.tags || [],
}));

// Get optimized backgrounds
const backgroundMap = await getOptimizedBackgrounds(getImage);

// Fetch recent blog posts for navigation
const recentPosts = await getRecentBlogPosts();
---

<Layout
  title='Blog - Ronniel Gandhe'
  description='Technical writing on systematic trading, infrastructure, and software engineering'
  canonical='https://ronnielgandhe.com/blog'
>
  <BlogLayout 
    client:load
    posts={formattedPosts}
    initialBg={getFixedBackgroundKey()}
    backgroundMap={backgroundMap}
    recentPosts={recentPosts}
  />
</Layout>