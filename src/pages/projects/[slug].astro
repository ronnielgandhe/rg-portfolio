---
export const prerender = true;

import { getCollection, getEntry } from 'astro:content';
import { getImage } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import ProjectDetailLayout from '../../layouts/ProjectDetailLayout';
import { getRecentBlogPosts } from '../../utils/blog';
import { getFixedBackgroundKey, getOptimizedBackgrounds } from '../../utils/backgrounds';
import 'katex/dist/katex.min.css';
import '../../styles/prose.css';
import '../../styles/code.css';
import '../../styles/math.css';

export async function getStaticPaths() {
  const projectEntries = await getCollection('projects');
  return projectEntries.map(project => ({
    params: { slug: project.data.slug || project.id.replace('.md', '') },
    props: { project },
  }));
}

// Get the project from props (pre-fetched)
const { project } = Astro.props;

if (!project) {
  return Astro.redirect('/404');
}

const { Content } = await project.render();

// Get optimized backgrounds
const backgroundMap = await getOptimizedBackgrounds(getImage);

// Fetch recent blog posts for navigation
const recentPosts = await getRecentBlogPosts();
---

<Layout
  title={`${project.data.title} - Ronniel Gandhe`}
  description={project.data.summary}
  canonical={`https://ronnielgandhe.com/projects/${project.id}`}
>
  <ProjectDetailLayout
    client:load
    title={project.data.title}
    summary={project.data.summary}
    year={project.data.year}
    tech={project.data.tech}
    slug={project.id}
    highlights={project.data.highlights}
    repoUrl={project.data.repoUrl}
    liveUrl={project.data.liveUrl}
    initialBg={getFixedBackgroundKey()}
    backgroundMap={backgroundMap}
    recentPosts={recentPosts}
  >
    <Content />
  </ProjectDetailLayout>
</Layout>

<script>
  import { initCopyButtons } from '../../scripts/copy-code';
  initCopyButtons();
</script>
